<p>As part of our quest to provide a complete and productive solution for developing highly responsive Web and Single Page Apps, ServiceStack now includes minifiers for compressing HTML, CSS and JavaScript available from the new <code>Minifiers</code> class: </p>

<div class="highlight highlight-source-cs"><pre><span class="pl-k">var</span> minifiedJs = Minifiers.JavaScript.Compress(js);
<span class="pl-k">var</span> minifiedCss = Minifiers.Css.Compress(css);
<span class="pl-k">var</span> minifiedHtml = Minifiers.Html.Compress(html);

<span class="pl-c">// Also minify in-line CSS and JavaScript</span>
<span class="pl-k">var</span> advancedMinifiedHtml = Minifiers.HtmlAdvanced.Compress(html);</pre></div>

<blockquote>
<p>Each minifier implements the lightweight <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack.Interfaces/ICompressor.cs">ICompressor</a> interface making it trivial to mock or subtitute with a custom implementation.</p>
</blockquote>

<h4>
<a id="user-content-js-minifier" class="anchor" href="#js-minifier" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>JS Minifier</h4>

<p>For the JavaScript minifier we're using <a href="https://github.com/extnet/Ext.NET.Utilities/blob/master/Ext.Net.Utilities/JavaScript/JSMin.cs">Ext.Net's C# port</a> of Douglas Crockford's venerable <a href="http://crockford.com/javascript/jsmin">JSMin</a>. </p>

<h4>
<a id="user-content-css-minifier" class="anchor" href="#css-minifier" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>CSS Minifier</h4>

<p>The CSS Minifer uses Mads Kristensen simple <a href="http://madskristensen.net/post/efficient-stylesheet-minification-in-c">CSS Minifer</a>. </p>

<h4>
<a id="user-content-html-compressor" class="anchor" href="#html-compressor" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>HTML Compressor</h4>

<p>For compressing HTML we're using a <a href="http://blog.magerquark.de/c-port-of-googles-htmlcompressor-library/">C# Port</a> of Google's excellent <a href="https://code.google.com/p/htmlcompressor/">HTML Compressor</a> which we've further modified to remove the public API's ugly Java-esque idioms and replaced them with C# properties.</p>

<p>The <code>HtmlCompressor</code> also includes a number of well-documented options which can be customized by configuring the available properties on its concrete type, e.g:</p>

<div class="highlight highlight-source-cs"><pre><span class="pl-k">var</span> htmlCompressor = (HtmlCompressor)Minifier.Html;
htmlCompressor.RemoveComments = <span class="pl-c1">false</span>;</pre></div>

<h3>
<a id="user-content-easy-win-for-server-generated-websites" class="anchor" href="#easy-win-for-server-generated-websites" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Easy win for server generated websites</h3>

<p>If your project is not based off one of our optimized Gulp/Grunt.js powered <a href="https://github.com/ServiceStack/ServiceStackVS">React JS and AngularJS Single Page App templates</a> or configured to use our eariler <a href="https://github.com/ServiceStack/Bundler">node.js-powered Bundler</a> Web Optimization solution, these built-in minifiers now offers the easiest solution to effortlessly optimize your existing website which is able to work transparently with your existing Razor Views and static <code>.js</code>, <code>.css</code> and <code>.html</code> files without requiring adding any additional external tooling or build steps to your existing development workflow.</p>

<h3>
<a id="user-content-minify-dynamic-razor-views" class="anchor" href="#minify-dynamic-razor-views" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Minify dynamic Razor Views</h3>

<p>Minification of Razor Views is easily enabled by specifying <code>MinifyHtml=true</code> when registering the <code>RazorFormat</code> plugin:</p>

<div class="highlight highlight-source-cs"><pre>Plugins.Add(<span class="pl-k">new</span> RazorFormat {
    MinifyHtml = <span class="pl-c1">true</span>,
    UseAdvancedCompression = <span class="pl-c1">true</span>,
});</pre></div>

<p>Use the <code>UseAdvancedCompression=true</code> option if you also want to minify inline js/css, although as this requires a bit more processing you'll want to benchmark it to see if it's providing an overall performance benefit to end users. It's a recommended option if you're caching Razor Pages. Another solution is to minimize the use of in-line js/css and move them to static files to avoid needing in-line js/css compression.</p>

<h3>
<a id="user-content-minify-static-js-css-and-html-files" class="anchor" href="#minify-static-js-css-and-html-files" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Minify static <code>.js</code>, <code>.css</code> and <code>.html</code> files</h3>

<p>With nothing other than the new minifiers, we can leverage the flexibility in ServiceStack's <a href="https://github.com/ServiceStack/ServiceStack/wiki/Virtual-file-system">Virtual File System</a> to provide an elegant solution for minifying static <code>.html</code>, <code>.css</code> and <code>.js</code> resources by simply pre-loading a new InMemory Virtual FileSystem with minified versions of existing files and giving the Memory FS a higher precedence so any matching requests serve up the minified version first. We only need to pre-load the minified versions once on StartUp by overriding <code>GetVirtualFileSources()</code> in the AppHost:</p>

<div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span> <span class="pl-k">override</span> List&lt;IVirtualPathProvider&gt; GetVirtualFileSources()
{
    <span class="pl-k">var</span> existingProviders = <span class="pl-c1">base</span>.GetVirtualFileSources();
    <span class="pl-k">var</span> memFs = <span class="pl-k">new</span> InMemoryVirtualPathProvider(<span class="pl-c1">this</span>);

    <span class="pl-c">//Get existing Local FileSystem Provider</span>
    <span class="pl-k">var</span> fs = existingProviders.First(x =&gt; x <span class="pl-k">is</span> FileSystemVirtualPathProvider);

    <span class="pl-c">//Process all .html files:</span>
    <span class="pl-k">foreach</span> (<span class="pl-k">var</span> file <span class="pl-k">in</span> fs.GetAllMatchingFiles(<span class="pl-s"><span class="pl-pds">"</span>*.html<span class="pl-pds">"</span></span>))
    {
        <span class="pl-k">var</span> contents = Minifiers.HtmlAdvanced.Compress(file.ReadAllText());
        memFs.AddFile(file.VirtualPath, contents);
    }

    <span class="pl-c">//Process all .css files:</span>
    <span class="pl-k">foreach</span> (<span class="pl-k">var</span> file <span class="pl-k">in</span> fs.GetAllMatchingFiles(<span class="pl-s"><span class="pl-pds">"</span>*.css<span class="pl-pds">"</span></span>)
      .Where(file =&gt; !file.VirtualPath.EndsWith(<span class="pl-s"><span class="pl-pds">"</span>.min.css<span class="pl-pds">"</span></span>))) <span class="pl-c">//ignore pre-minified .css</span>
    {
        <span class="pl-k">var</span> contents = Minifiers.Css.Compress(file.ReadAllText());
        memFs.AddFile(file.VirtualPath, contents);
    }

    <span class="pl-c">//Process all .js files</span>
    <span class="pl-k">foreach</span> (<span class="pl-k">var</span> file <span class="pl-k">in</span> fs.GetAllMatchingFiles(<span class="pl-s"><span class="pl-pds">"</span>*.js<span class="pl-pds">"</span></span>)
      .Where(file =&gt; !file.VirtualPath.EndsWith(<span class="pl-s"><span class="pl-pds">"</span>.min.js<span class="pl-pds">"</span></span>))) <span class="pl-c">//ignore pre-minified .js</span>
    {
        <span class="pl-k">try</span>
        {
            <span class="pl-k">var</span> js = file.ReadAllText();
            <span class="pl-k">var</span> contents = Minifiers.JavaScript.Compress(js);
            memFs.AddFile(file.VirtualPath, contents);
        }
        <span class="pl-k">catch</span> (Exception ex)
        {
            <span class="pl-c">//As JSMin is a strict subset of JavaScript, this can fail on valid JS.</span>
            <span class="pl-c">//We can report exceptions in StartUpErrors so they're visible in ?debug=requestinfo</span>
            <span class="pl-c1">base</span>.OnStartupException(<span class="pl-k">new</span> Exception(<span class="pl-s"><span class="pl-pds">"</span>JSMin Error {0}: {1}<span class="pl-pds">"</span></span>.Fmt(file.VirtualPath, ex.Message)));
        }
    }

    <span class="pl-c">//Give new Memory FS the highest priority</span>
    existingProviders.Insert(<span class="pl-c1">0</span>, memFs);
    <span class="pl-k">return</span> existingProviders;
}</pre></div>

<p>A nice benefit of this approach is that it doesn't pollute your project with minified build artifacts, has excellent runtime performance with the minfied contents being served from Memory and as the file names remain the same, the links in HTML don't need to be rewritten to reference the minified versions. i.e. When a request is made it just looks through the registered virtual path providers and returns the first match, which given the Memory FS was inserted at the start of the list, returns the minified version.</p>

<h3>
<a id="user-content-enabled-in-servicestacknet" class="anchor" href="#enabled-in-servicestacknet" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Enabled in <a href="https://servicestack.net">servicestack.net</a>
</h3>

<p>As this was an quick and non-invasive feature to add, we've enabled it on all <a href="https://servicestack.net">servicestack.net</a> Razor views and static files. You can <code>view-source:https://servicestack.net/</code> (as url in Chrome, Firefox or Opera) to see an example of the resulting minified output. </p>
