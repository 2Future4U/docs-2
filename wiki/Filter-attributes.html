<p>ServiceStack also contains interfaces for attributes which can be executed before and after a request like request/response filters. The filter attributes are great for composing re-usable functionality as you can wrap common functionality in a Filter Attribute and selectively annotate which Services they should apply to. </p>

<p>For example, ServiceStack uses <code>[Authenticate]</code> and <code>[RequiredPermission]</code> filter attributes to decorate which Services should be protected with authentication or specific permissions (see <a href="https://github.com/ServiceStack/ServiceStack/wiki/Authentication-and-authorization">Authentication and authorization</a>).</p>

<h3>
<a id="user-content-request-filter-attributes" class="anchor" href="#request-filter-attributes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Request Filter Attributes</h3>

<p>You can create a Filter Attribute by implementing one of the Request or Response Filter interfaces below:</p>

<div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span> <span class="pl-k">interface</span> <span class="pl-en">IHasRequestFilter</span> 
{
    <span class="pl-k">void</span> <span class="pl-en">RequestFilter</span>(<span class="pl-k">IRequest</span> <span class="pl-smi">req</span>, <span class="pl-k">IResponse</span> <span class="pl-smi">res</span>, <span class="pl-k">object</span> <span class="pl-smi">requestDto</span>);
    <span class="pl-k">int</span> <span class="pl-en">Priority</span> { <span class="pl-k">get</span>; }      <span class="pl-c">// &lt;0 Run before global filters. &gt;=0 Run after</span>
    IHasRequestFilter <span class="pl-en">Copy</span>();  <span class="pl-c">// Optimization: fast creation of new instances</span>
}</pre></div>

<h3>
<a id="user-content-response-filter-attributes" class="anchor" href="#response-filter-attributes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Response Filter Attributes</h3>

<p>If you implement this interface, the method <code>ResponseFilter</code> will be executed after the service was called.</p>

<div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span> <span class="pl-k">interface</span> <span class="pl-en">IHasResponseFilter</span> 
{
    <span class="pl-k">void</span> <span class="pl-en">ResponseFilter</span>(<span class="pl-k">IRequest</span> <span class="pl-smi">req</span>, <span class="pl-k">IResponse</span> <span class="pl-smi">res</span>, <span class="pl-k">object</span> <span class="pl-smi">responseDto</span>);
    <span class="pl-k">int</span> <span class="pl-en">Priority</span> { <span class="pl-k">get</span>; }      <span class="pl-c">// &lt;0 Run before global filters. &gt;=0 Run after</span>
    IHasResponseFilter <span class="pl-en">Copy</span>();  <span class="pl-c">// Optimization: fast creation of new instances</span>
}</pre></div>

<h3>
<a id="user-content-action-filter-attributes" class="anchor" href="#action-filter-attributes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Action Filter Attributes</h3>

<p>Method-level filter attributes are always executed just before/after the Service, i.e. the Priority is only scoped and sorted between other method-level attributes.</p>

<h2>
<a id="user-content-filter-attributes-example" class="anchor" href="#filter-attributes-example" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Filter Attributes Example</h2>

<p>It's recommended that you create separate attributes for each interface, but of course you can implement both interfaces in one attribute, too.</p>

<div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">CustomRequestFilterAttribute</span> : <span class="pl-k">RequestFilterAttribute</span> 
{
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">RequestFilter</span>(<span class="pl-k">IRequest</span> <span class="pl-smi">req</span>, <span class="pl-k">IResponse</span> <span class="pl-smi">res</span>, <span class="pl-k">object</span> <span class="pl-smi">requestDto</span>)
    {
        <span class="pl-c">//This code is executed before the service</span>
        <span class="pl-k">string</span> userAgent = req.UserAgent;
        StatisticManager.SaveUserAgent(userAgent);
    }
}</pre></div>

<div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">CustomResponseFilterAttribute</span> : <span class="pl-k">ResponseFilterAttribute</span> 
{
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">ResponseFilter</span>(<span class="pl-k">IRequest</span> <span class="pl-smi">req</span>, <span class="pl-k">IResponse</span> <span class="pl-smi">res</span>, <span class="pl-k">object</span> <span class="pl-smi">responseDto</span>)
    {
        <span class="pl-c">//This code is executed after the service</span>
        res.AddHeader(<span class="pl-s"><span class="pl-pds">"</span>Cache-Control<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>max-age=3600<span class="pl-pds">"</span></span>);
    }
}</pre></div>

<p>As you can see, you can access the <code>IHttpRequest</code>, <code>IHttpResponse</code> and the request/response DTO. So you can change the DTO, the http response (eg status code) or look for a specific header in the http request.  You can also attach any data to this request via the IHttpRequest.Items dictionary that all subsequent filters and services can access.</p>

<h2>
<a id="user-content-example-usage" class="anchor" href="#example-usage" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Example Usage</h2>

<p>These two attributes have to be added to a request/response DTO or to the service implementation to enable them.</p>

<div class="highlight highlight-source-cs"><pre>
<span class="pl-c">//Request DTO</span>
[Route(<span class="pl-s"><span class="pl-pds">"</span>/aspect<span class="pl-pds">"</span></span>)]
[CustomRequestFilter]
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">User</span>
{
    <span class="pl-k">public</span> <span class="pl-k">string</span> <span class="pl-en">Name</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
    <span class="pl-k">public</span> <span class="pl-k">string</span> <span class="pl-en">Company</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
    <span class="pl-k">public</span> <span class="pl-k">int</span> <span class="pl-en">Age</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
    <span class="pl-k">public</span> <span class="pl-k">int</span> <span class="pl-en">Count</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
}

<span class="pl-c">//Response DTO</span>
[CustomResponseFilter]
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">UserResponse</span> : <span class="pl-k">IHasResponseStatus</span>
{
    <span class="pl-k">public</span> <span class="pl-k">string</span> <span class="pl-en">Car</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
    <span class="pl-k">public</span> ResponseStatus <span class="pl-en">ResponseStatus</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
}</pre></div>

<p>...or if you don't want the code-first DTOs messed with attributes:</p>

<div class="highlight highlight-source-cs"><pre>[CustomRequestFilter]
[CustomResponseFilter]
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">AspectService</span> : <span class="pl-k">Service</span>
{
    <span class="pl-k">public</span> <span class="pl-k">object</span> <span class="pl-en">Get</span>(<span class="pl-k">Aspect</span> <span class="pl-smi">request</span>)
    {
        ...
    }
}</pre></div>

<p>That's all, now ServiceStack recognizes the attributes and executes them on every call! </p>

<h3>
<a id="user-content-dependencies-are-auto-wired" class="anchor" href="#dependencies-are-auto-wired" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Dependencies are auto-wired</h3>

<p>Just like in Services and Validators, the filter attributes are also auto-wired, e.g:</p>

<div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">CustomRequestFilterAttribute</span> : <span class="pl-k">RequestFilterAttribute</span>
{
    <span class="pl-c">//This property will be resolved by the IoC container</span>
    <span class="pl-k">public</span> ICacheClient <span class="pl-en">Cache</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }

    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">RequestFilter</span>(<span class="pl-k">IRequest</span> <span class="pl-smi">req</span>, <span class="pl-k">IResponse</span> <span class="pl-smi">res</span>, <span class="pl-k">object</span> <span class="pl-smi">requestDto</span>)
    {
        <span class="pl-c">//Access the property 'Cache' here</span>

        <span class="pl-c">//This code is executed before the service</span>
        <span class="pl-k">string</span> userAgent = req.UserAgent;
        StatisticManager.SaveUserAgent(userAgent);
    }
}</pre></div>

<p>In this case the property <code>Cache</code> will be tried to be resolved by the IoC container.</p>

<h3>
<a id="user-content-requestfilterattribute-base-class" class="anchor" href="#requestfilterattribute-base-class" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>RequestFilterAttribute base class</h3>

<p>ServiceStack also has two base classes, which implement the above interfaces, which make it easier to create contextual filters. Contextual filters are only executed on specific HTTP verbs (GET, POST...).</p>

<div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">StatisticFilterAttribute</span> : <span class="pl-k">RequestFilterAttribute</span>
{
    <span class="pl-c">//This property will be resolved by the IoC container</span>
    <span class="pl-k">public</span> ICacheClient <span class="pl-en">Cache</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }

    <span class="pl-k">public</span> <span class="pl-en">StatisticFilterAttribute</span>() {}

    <span class="pl-k">public</span> <span class="pl-en">StatisticFilterAttribute</span>(<span class="pl-k">ApplyTo</span> <span class="pl-smi">applyTo</span>)
        : <span class="pl-c1">base</span>(applyTo) {}

    <span class="pl-k">public</span> <span class="pl-k">override</span> <span class="pl-k">void</span> <span class="pl-en">Execute</span>(<span class="pl-k">IRequest</span> <span class="pl-smi">req</span>, <span class="pl-k">IResponse</span> <span class="pl-smi">res</span>, <span class="pl-k">object</span> <span class="pl-smi">requestDto</span>)
    {
        <span class="pl-c">//This code is executed before the service</span>
        <span class="pl-k">string</span> userAgent = req.UserAgent;
        StatisticManager.SaveUserAgent(userAgent);
    }
}</pre></div>

<blockquote>
<p>The <code>ResponseFilterAttribute</code> base class can be used for Response Filter Attributes which works the same as <code>RequestFilterAttribute</code> above.</p>
</blockquote>

<h3>
<a id="user-content-conditionally-apply-filter-attributes" class="anchor" href="#conditionally-apply-filter-attributes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Conditionally Apply Filter Attributes</h3>

<p>The base class <code>RequestFilterAttribute</code> has an empty constructor and a constructor which takes the <code>ApplyTo</code> flag. If the empty constructor is called, the method <code>Execute</code> will be called on every HTTP verb (<code>ApplyTo.All</code>), with the other constructor it will be called only on the configured HTTP verbs (eg <code>ApplyTo.Get | ApplyTo.Post</code>).</p>

<p>So you can use the attribute on your request DTO/service like that:</p>

<div class="highlight highlight-source-cs"><pre><span class="pl-c">//Filter will be executed on every request</span>
[StatisticFilter]
...

<span class="pl-c">//Filter will be executed only on GET and POST requests</span>
[StatisticFilter(ApplyTo.Get | ApplyTo.Post)]
...</pre></div>
