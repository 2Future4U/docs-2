<p>This article explains how to make use of ServiceStack components in existing <strong>ASP.NET MVC</strong> and <strong>WebForms</strong> Web Applications. The base <code>ServiceStackController</code> and WebForms <code>ServiceStackPage</code> both share a common code-base  to provide easy access to the same clean, high-performance components found in ServiceStack's <code>Service</code> base class, directly from within your MVC Controllers and WebForm pages.</p>

<p>This is an outline of the API's found in MVC's <code>ServiceStackController</code> and WebForms <code>ServiceStackPage</code>:</p>

<div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">ServiceStackController</span> : <span class="pl-k">Controller</span>
{
    <span class="pl-c">//...</span>
    IServiceStackProvider <span class="pl-en">ServiceStackProvider</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
    IAppSettings <span class="pl-en">AppSettings</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
    IHttpRequest <span class="pl-en">ServiceStackRequest</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
    IHttpResponse <span class="pl-en">ServiceStackResponse</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
    ICacheClient <span class="pl-en">Cache</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
    IDbConnection <span class="pl-en">Db</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
    IRedisClient <span class="pl-en">Redis</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
    IMessageFactory <span class="pl-en">MessageFactory</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
    IMessageProducer <span class="pl-en">MessageProducer</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
    ISessionFactory <span class="pl-en">SessionFactory</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
    ISession <span class="pl-en">SessionBag</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
    <span class="pl-k">bool</span> <span class="pl-en">IsAuthenticated</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }

    T TryResolve&lt;T&gt;();
    T ResolveService&lt;T&gt;();
    <span class="pl-k">object</span> <span class="pl-en">Execute</span>(<span class="pl-k">object</span> <span class="pl-smi">requestDto</span>);
    <span class="pl-k">object</span> <span class="pl-en">ForwardRequestToServiceStack</span>(<span class="pl-k">IRequest</span> <span class="pl-smi">request</span><span class="pl-k">=</span><span class="pl-c1">null</span>);
    IAuthSession <span class="pl-en">GetSession</span>(<span class="pl-k">bool</span> <span class="pl-smi">reload</span> <span class="pl-k">=</span> <span class="pl-c1">true</span>);
    TUserSession SessionAs&lt;TUserSession&gt;();
    <span class="pl-k">void</span> <span class="pl-en">ClearSession</span>();
    <span class="pl-k">void</span> PublishMessage&lt;T&gt;(T message);
}</pre></div>

<h3>
<a id="user-content-use-servicestack-authentication" class="anchor" href="#use-servicestack-authentication" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Use ServiceStack Authentication</h3>

<p>One benefit of integration with ServiceStack is to be able to make use of ServiceStack's simple and flexible <a href="https://github.com/ServiceStack/ServiceStack/wiki/Authentication-and-authorization">Authentication Providers</a> which require minimal configuration and supports a number of different <a href="https://github.com/ServiceStack/ServiceStack/wiki/Caching">Session Providers</a> and persistent <a href="https://github.com/ServiceStack/ServiceStack/wiki/Authentication-and-authorization#userauth-persistence---the-iuserauthrepository">Data Store back-ends</a> to make it easy to integrate with an existing environment.</p>

<h3>
<a id="user-content-new-mvc-and-webforms-examples" class="anchor" href="#new-mvc-and-webforms-examples" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>New MVC and WebForms Examples</h3>

<p>To illustrate the seamless integration with ServiceStack, we've created 2 new authentication-enabled example websites:</p>

<ul>
<li>
<strong>ASP.NET MVC</strong> Live Demo: <a href="http://mvc.servicestack.net/">mvc.servicestack.net</a> and <a href="https://github.com/ServiceStack/Test/tree/master/src/Mvc">source code</a>
</li>
<li>
<strong>ASP.NET WebForms</strong> Live Demo: <a href="http://webforms.servicestack.net/">webforms.servicestack.net</a> and <a href="https://github.com/ServiceStack/Test/tree/master/src/WebForms">source code</a>
</li>
</ul>

<p><a href="https://raw.githubusercontent.com/ServiceStack/Assets/master/img/release-notes/mvc-integration.png" target="_blank"><img src="https://raw.githubusercontent.com/ServiceStack/Assets/master/img/release-notes/mvc-integration.png" alt="MVC with ServiceStack Authentication" style="max-width:100%;"></a></p>

<h3>
<a id="user-content-integrating-with-servicestack-from-mvc-or-webforms" class="anchor" href="#integrating-with-servicestack-from-mvc-or-webforms" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Integrating with ServiceStack from MVC or WebForms</h3>

<p>We'll go through the MVC example to showcase the different ways you can integrate with ServiceStack from an external Web Framework. </p>

<h4>
<a id="user-content-using-resolveservice-to-call-services-directly" class="anchor" href="#using-resolveservice-to-call-services-directly" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Using ResolveService to call Services directly</h4>

<p>The <code>Login</code> Action is a standard MVC Action handling HTML Form input accepting 3 parameters, a <code>userName</code>, <code>password</code> as well as a relative <code>redirect</code> url to redirect to when authentication is successful. Login uses the <code>ResolveService&lt;TService&gt;</code> API which just resolves an auto-wired instance of the ServiceStack <code>AuthenticateService</code> from the IOC and injects the current HTTP Request context, which we then use to call a method on the Service directly:</p>

<div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span> ActionResult Login(<span class="pl-k">string</span> userName, <span class="pl-k">string</span> password, <span class="pl-k">string</span> redirect=<span class="pl-c1">null</span>)
{
    <span class="pl-k">if</span> (ModelState.IsValid)
    {
        <span class="pl-k">try</span>
        {
            <span class="pl-k">using</span> (<span class="pl-k">var</span> authService = ResolveService&lt;AuthenticateService&gt;())
            {
                <span class="pl-k">var</span> response = authService.Authenticate(<span class="pl-k">new</span> Authenticate {
                    provider = CredentialsAuthProvider.Name,
                    UserName = userName,
                    Password = password,
                    RememberMe = <span class="pl-c1">true</span>,
                });

                <span class="pl-c">// add ASP.NET auth cookie</span>
                FormsAuthentication.SetAuthCookie(userName, <span class="pl-c1">true</span>);

                <span class="pl-k">return</span> Redirect(<span class="pl-k">string</span>.IsNullOrEmpty(redirect) ? <span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span> : redirect);
            }
        }
        <span class="pl-k">catch</span> (Exception ex)
        {
            ModelState.AddModelError(<span class="pl-k">string</span>.Empty, ex.Message);
        }
    }

    <span class="pl-k">return</span> View(<span class="pl-s"><span class="pl-pds">"</span>Index<span class="pl-pds">"</span></span>, GetViewModel());
}</pre></div>

<blockquote>
<p>Since the above example calls the Service method directly any exceptions raised by the Service implementation are thrown and caught as normal.</p>
</blockquote>

<h4>
<a id="user-content-using-execute-to-process-request-dtos" class="anchor" href="#using-execute-to-process-request-dtos" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Using Execute to process Request DTO's</h4>

<p>The <code>Logout()</code> MVC Action uses ServiceStack's <code>Execute()</code> API which can call the desired ServiceStack Service with just a populated Request DTO:</p>

<div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span> ActionResult Logout()
{
    Execute(<span class="pl-k">new</span> Authenticate { provider = <span class="pl-s"><span class="pl-pds">"</span>logout<span class="pl-pds">"</span></span> });
    FormsAuthentication.SignOut(); 

    <span class="pl-k">return</span> Redirect(<span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>);
}</pre></div>

<h4>
<a id="user-content-using-forwardrequesttoservicestack-to-proxy-http-requests" class="anchor" href="#using-forwardrequesttoservicestack-to-proxy-http-requests" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Using ForwardRequestToServiceStack to proxy HTTP Requests</h4>

<p>The <code>ForwardingController</code> handles OAuth callbacks that have been configured to callback to <code>/auth/*</code> route which is handled by MVC as ServiceStack is mounted at and only configured to handle <code>/api</code> requests. </p>

<p>Instead of creating new OAuth Applications with each provider to use the new <code>/api/auth/*</code> callback url so ServiceStack can handle the OAuth callback, we can use just use the new <code>ForwardRequestToServiceStack()</code> which just forwards the incoming HTTP Request from MVC to ServiceStack to process, effectively acting as a proxy:</p>

<div class="highlight highlight-source-cs"><pre>routes.MapRoute(<span class="pl-s"><span class="pl-pds">"</span>Forwarding<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>auth/{*pathinfo}<span class="pl-pds">"</span></span>, 
    <span class="pl-k">new</span> { controller = <span class="pl-s"><span class="pl-pds">"</span>Forwarding<span class="pl-pds">"</span></span>, action = <span class="pl-s"><span class="pl-pds">"</span>Index<span class="pl-pds">"</span></span> });
...

<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">ForwardingController</span> : <span class="pl-k">ServiceStackController</span>
{
    <span class="pl-k">public</span> ActionResult <span class="pl-en">Index</span>()
    {
        <span class="pl-k">var</span> response = ForwardRequestToServiceStack();
        <span class="pl-k">if</span> (ServiceStackResponse.IsClosed) <span class="pl-k">return</span> <span class="pl-k">new</span> EmptyResult();

        <span class="pl-k">string</span> redirectUrl;
        <span class="pl-k">var</span> httpResult = response <span class="pl-k">as</span> IHttpResult;
        <span class="pl-k">if</span> (httpResult != <span class="pl-c1">null</span> &amp;&amp; httpResult.Headers.TryGetValue(HttpHeaders.Location, out redirectUrl))
            <span class="pl-k">return</span> Redirect(redirectUrl);

        <span class="pl-k">return</span> Redirect(<span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>);
    }
}</pre></div>

<p>The <code>Execute()</code> and <code>ForwardRequestToServiceStack()</code> are high-level API's that call into ServiceStack's internal Request pipeline, executing any Action Filters and also converts any exceptions into a populated serializable Response DTO with a populated <code>ResponseStatus</code> as would be returned to Service Clients.</p>

<h3>
<a id="user-content-authentication-attributes" class="anchor" href="#authentication-attributes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Authentication Attributes</h3>

<p>Since we're using ServiceStack for Authentication, we're also able to re-use ServiceStack's Authentication Attribute Filters directly on MVC Controllers and WebForm Pages just as if they were ServiceStack Services, e.g:</p>

<div class="highlight highlight-source-cs"><pre>[Authenticate]
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">AuthOnlyController</span> : <span class="pl-k">ServiceStackController</span> 
{
    <span class="pl-k">public</span> ActionResult <span class="pl-en">Index</span>()
    {
        <span class="pl-k">return</span> View(SessionAs&lt;CustomUserSession&gt;());
    }         
}</pre></div>

<p>The above controller hanldes the <a href="http://mvc.servicestack.net/AuthOnly">mvc.servicestack.net/AuthOnly</a> route which only allows access to Authorized users. If a user is not authenticated they're automatically redirected to <a href="http://mvc.servicestack.net/?redirect=%2fAuthOnly#f=Unauthorized">/?redirect=/AuthOnly#f=Unauthorized</a> to prompt the user to login, after successfully logging in it will redirect back to the original <code>/AuthOnly</code> url.</p>

<h3>
<a id="user-content-required-role-or-permission" class="anchor" href="#required-role-or-permission" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Required Role or Permission</h3>

<p>The <code>[RequiredRole]</code> and <code>[RequiredPermission]</code> attributes work similar to the <code>[Authentication]</code> attribute except they also assert that the user is a member of the specified role:</p>

<div class="highlight highlight-source-cs"><pre>[RequiredRole(<span class="pl-s"><span class="pl-pds">"</span>TheRole<span class="pl-pds">"</span></span>)]
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">RequiresRoleController</span> : <span class="pl-k">ServiceStackController</span> 
{
    <span class="pl-k">public</span> ActionResult <span class="pl-en">Index</span>()
    {
        <span class="pl-k">return</span> View(SessionAs&lt;CustomUserSession&gt;());
    }
}</pre></div>

<p>The above Controller handles the <a href="http://mvc.servicestack.net/RequiresRole">/RequiresRole</a> Route and will only grant access if the Authenticated User is also a member of the <strong>TheRole</strong>.</p>

<h3>
<a id="user-content-calling-servicestack-services-directly" class="anchor" href="#calling-servicestack-services-directly" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Calling ServiceStack Services Directly</h3>

<p>The simplest way to consume ServiceStack Services requiring the least effort and moving parts is to call them directly: </p>

<h4>
<a id="user-content-using-servicestack-oauth-in-mvc" class="anchor" href="#using-servicestack-oauth-in-mvc" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Using ServiceStack OAuth in MVC</h4>

<p>Integrating with ServiceStack's OAuth providers requires the least effort as they're linkable directly in the format <code>/api/auth/{provider}</code> which is handled by ServiceStack's OAuth Service who initiates the Authentication process by redirecting to the selected OAuth provider:</p>

<p><a href="https://raw.githubusercontent.com/ServiceStack/Assets/master/img/release-notes/mvc-auth.png" target="_blank"><img src="https://raw.githubusercontent.com/ServiceStack/Assets/master/img/release-notes/mvc-auth.png" alt="MVC OAuth with HTML" style="max-width:100%;"></a></p>

<h4>
<a id="user-content-calling-servicestack-with-ajax-in-mvc" class="anchor" href="#calling-servicestack-with-ajax-in-mvc" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Calling ServiceStack with Ajax in MVC</h4>

<p>Posting HTML Forms directly to ServiceStack Services isn't that much more effort, Start with a plain HTML Form with field names that match with the Services property names:</p>

<p><a href="https://raw.githubusercontent.com/ServiceStack/Assets/master/img/release-notes/mvc-register.png" target="_blank"><img src="https://raw.githubusercontent.com/ServiceStack/Assets/master/img/release-notes/mvc-register.png" alt="MVC Register with HTML" style="max-width:100%;"></a></p>

<p>We can then use ServiceStack's built-in <a href="https://github.com/ServiceStack/ServiceStack/wiki/ss-utils.js-JavaScript-Client-Library">ss-utils.js JavaScript Libraray</a> to take care of Ajaxifying, auto-binding and submitting the form via Ajax. It also has built-in support for <a href="https://github.com/ServiceStack/ServiceStack/wiki/ss-utils.js-JavaScript-Client-Library#bootstrap-forms">Bootstrap Forms Field Validation conventions</a> to automatically bind errors to the appropriate fields. The only custom code required is to bind the form is then:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">"</span>#form-register<span class="pl-pds">"</span></span>).<span class="pl-en">bindForm</span>({
    <span class="pl-en">success</span><span class="pl-k">:</span> <span class="pl-k">function</span> (<span class="pl-smi">r</span>) { <span class="pl-smi">location</span>.<span class="pl-c1">href</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>; }
});</pre></div>

<p>In this case we've added a success callback to redirect to the home page if the registration was successful which will either be authenticated with the newly registered user if <strong>Auto Login</strong> was checked, otherwise you can use the login form to Sign in as the newly registered user.</p>
