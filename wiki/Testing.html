<p>The tests in <a href="https://github.com/ServiceStack/ServiceStack/tree/master/tests/ServiceStack.WebHost.Endpoints.Tests">ServiceStack.WebHost.Endpoints.Tests</a> show good examples of how to create stand-alone integration tests that just use a self-hosted HttpListener AppHost. </p>

<h2>
<a id="user-content-example-stand-alone-integration-tests" class="anchor" href="#example-stand-alone-integration-tests" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Example Stand-alone Integration tests</h2>

<ul>
<li><a href="https://github.com/ServiceStack/ServiceStack/blob/master/tests/ServiceStack.WebHost.Endpoints.Tests/BufferedRequestTests.cs">BufferedRequestTests</a></li>
<li><a href="https://github.com/ServiceStack/ServiceStack/blob/master/tests/ServiceStack.WebHost.Endpoints.Tests/AuthTests.cs">AuthTests</a></li>
</ul>

<h2>
<a id="user-content-unit-testing" class="anchor" href="#unit-testing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Unit testing</h2>

<p>If you want to unit test a ServiceStack Service in isolation there are a couple of different approaches you can take. The base <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack/Service.cs">Service</a> class itself is just a simple C# class which lets you define and inject dependencies manually or by using the built-in IOC container. </p>

<p>We'll illustrate both approaches using this <a href="https://github.com/ServiceStack/ServiceStack/blob/master/tests/ServiceStack.WebHost.Endpoints.Tests/UnitTestExample.cs">simple unit test example</a> that tests this simple Service:</p>

<div class="highlight highlight-source-cs"><pre><span class="pl-c">// DTOs</span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">FindRockstars</span>
{
   <span class="pl-k">public</span> <span class="pl-k">int</span>? <span class="pl-en">Aged</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
   <span class="pl-k">public</span> <span class="pl-k">bool</span>? <span class="pl-en">Alive</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
}

<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">GetStatus</span>
{
   <span class="pl-k">public</span> <span class="pl-k">string</span> <span class="pl-en">LastName</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
}

<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">RockstarStatus</span>
{
   <span class="pl-k">public</span> <span class="pl-k">int</span> <span class="pl-en">Age</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
   <span class="pl-k">public</span> <span class="pl-k">bool</span> <span class="pl-en">Alive</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
}

<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">Rockstar</span>
{
   [AutoIncrement]
   <span class="pl-k">public</span> <span class="pl-k">int</span> <span class="pl-en">Id</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
   <span class="pl-k">public</span> <span class="pl-k">string</span> <span class="pl-en">FirstName</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
   <span class="pl-k">public</span> <span class="pl-k">string</span> <span class="pl-en">LastName</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
   <span class="pl-k">public</span> <span class="pl-k">int</span>? <span class="pl-en">Age</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
}

<span class="pl-c">// Implementation</span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">SimpleService</span> : <span class="pl-k">Service</span>
{
   <span class="pl-k">public</span> IRockstarRepository <span class="pl-en">RockstarRepository</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }

   <span class="pl-k">public</span> List&lt;Rockstar&gt; <span class="pl-en">Get</span>(<span class="pl-k">FindRockstars</span> <span class="pl-smi">request</span>)
   {
      <span class="pl-k">return</span> request.Aged.HasValue
          ? Db.Select&lt;Rockstar&gt;(q =&gt; q.Age == request.Aged.Value)
          : Db.Select&lt;Rockstar&gt;();
   }

   <span class="pl-k">public</span> RockstarStatus <span class="pl-en">Get</span>(<span class="pl-k">GetStatus</span> <span class="pl-smi">request</span>)
   {
      <span class="pl-k">var</span> rockstar = RockstarRepository.GetByLastName(request.LastName);
      <span class="pl-k">if</span> (rockstar == <span class="pl-c1">null</span>)
          <span class="pl-k">throw</span> HttpError.NotFound(<span class="pl-s"><span class="pl-pds">"</span>'{0}' is not a Rockstar<span class="pl-pds">"</span></span>.Fmt(request.LastName));

      <span class="pl-k">var</span> status = <span class="pl-k">new</span> RockstarStatus
      {
          Alive = RockstarRepository.IsAlive(request.LastName)
      }.PopulateWith(rockstar); <span class="pl-c">//Populates with matching fields</span>

      <span class="pl-k">return</span> status;
   }
}</pre></div>

<p>This Service provides 2 operations, <code>FindRockstars</code> which makes db queries directly in the service class itself, and <code>GetStatus</code> which uses a repository instead for all its Data access.</p>

<h3>
<a id="user-content-using-an-in-memory-database" class="anchor" href="#using-an-in-memory-database" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Using an in-memory database</h3>

<p>If you're accessing <code>Db</code> from directly within your service implementation you're going to want to make use of a real DB given the <a href="http://msdn.microsoft.com/en-us/library/system.data.idbconnection.aspx">ADO.NET IDbConnection</a> requires a lot of effort to mock. You can do this in the same way you would register your dependencies in ServiceStack itself, by using the built-in IOC. For a unit test we can do this without an AppHost by just use a new <code>Container</code> in your <code>TestFixtureSetup</code>, e.g:</p>

<h3>
<a id="user-content-test-setup" class="anchor" href="#test-setup" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Test Setup</h3>

<div class="highlight highlight-source-cs"><pre><span class="pl-k">private</span> ServiceStackHost appHost;

[TestFixtureSetUp]
<span class="pl-k">public</span> <span class="pl-k">void</span> TestFixtureSetUp()
{
    appHost = <span class="pl-k">new</span> BasicAppHost().Init();
    <span class="pl-k">var</span> container = appHost.Container;

    container.Register&lt;IDbConnectionFactory&gt;(
        <span class="pl-k">new</span> OrmLiteConnectionFactory(<span class="pl-s"><span class="pl-pds">"</span>:memory:<span class="pl-pds">"</span></span>, SqliteDialect.Provider));

    container.RegisterAutoWiredAs&lt;RockstarRepository, IRockstarRepository&gt;();

    container.RegisterAutoWired&lt;SimpleService&gt;();

    <span class="pl-k">using</span> (<span class="pl-k">var</span> db = container.Resolve&lt;IDbConnectionFactory&gt;().Open())
    {
        db.DropAndCreateTable&lt;Rockstar&gt;();
        db.InsertAll(SeedData);
    }
}

[TestFixtureTearDown]
<span class="pl-k">public</span> <span class="pl-k">void</span> TestFixtureTearDown()
{
    appHost.Dispose();
}</pre></div>

<p>With everything setup we can now test the service just like a normal C# class in isolation independently of ServiceStack itself:</p>

<div class="highlight highlight-source-cs"><pre>[Test]
<span class="pl-k">public</span> <span class="pl-k">void</span> Using_in_memory_database()
{
    <span class="pl-c">//Resolve the autowired service from IOC and set Resolver for the base class</span>
    <span class="pl-k">var</span> service = appHost.Container.Resolve&lt;SimpleService&gt;(); 

    <span class="pl-k">var</span> rockstars = service.Get(<span class="pl-k">new</span> FindRockstars { Aged = <span class="pl-c1">27</span> });

    rockstars.PrintDump(); <span class="pl-c">//Print a dump of the results to Console</span>

    Assert.That(rockstars.Count, Is.EqualTo(SeedData.Count(x =&gt; x.Age == <span class="pl-c1">27</span>)));

    <span class="pl-k">var</span> status = service.Get(<span class="pl-k">new</span> GetStatus { LastName = <span class="pl-s"><span class="pl-pds">"</span>Vedder<span class="pl-pds">"</span></span> });
    Assert.That(status.Age, Is.EqualTo(<span class="pl-c1">48</span>));
    Assert.That(status.Alive, Is.True);

    status = service.Get(<span class="pl-k">new</span> GetStatus { LastName = <span class="pl-s"><span class="pl-pds">"</span>Hendrix<span class="pl-pds">"</span></span> });
    Assert.That(status.Age, Is.EqualTo(<span class="pl-c1">27</span>));
    Assert.That(status.Alive, Is.False);

    Assert.Throws&lt;HttpError&gt;(() =&gt;
        service.Get(<span class="pl-k">new</span> GetStatus { LastName = <span class="pl-s"><span class="pl-pds">"</span>Unknown<span class="pl-pds">"</span></span> }));
}</pre></div>

<h3>
<a id="user-content-manually-injecting-dependencies" class="anchor" href="#manually-injecting-dependencies" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Manually injecting dependencies</h3>

<p>If you prefer your unit tests not to use an in-memory database, you can instead choose to mock your dependencies. In this example we'll use a stand-alone Mock, but you can reduce boilerplate by using mocking library like <a href="https://github.com/Moq/moq">Moq</a> instead.</p>

<div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">RockstarRepositoryMock</span> : <span class="pl-k">IRockstarRepository</span>
{
    <span class="pl-k">public</span> Rockstar <span class="pl-en">GetByLastName</span>(<span class="pl-k">string</span> <span class="pl-smi">lastName</span>)
    {
        <span class="pl-k">return</span> lastName == <span class="pl-s"><span class="pl-pds">"</span>Vedder<span class="pl-pds">"</span></span>
            ? <span class="pl-k">new</span> Rockstar(<span class="pl-c1">6</span>, <span class="pl-s"><span class="pl-pds">"</span>Eddie<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Vedder<span class="pl-pds">"</span></span>, <span class="pl-c1">48</span>)
            : <span class="pl-c1">null</span>;
    }

    <span class="pl-k">public</span> <span class="pl-k">bool</span> <span class="pl-en">IsAlive</span>(<span class="pl-k">string</span> <span class="pl-smi">lastName</span>)
    {
        <span class="pl-k">return</span> lastName == <span class="pl-s"><span class="pl-pds">"</span>Grohl<span class="pl-pds">"</span></span> || lastName == <span class="pl-s"><span class="pl-pds">"</span>Vedder<span class="pl-pds">"</span></span>;
    }
}

[Test]
<span class="pl-k">public</span> <span class="pl-k">void</span> Using_manual_dependency_injection()
{
    <span class="pl-k">var</span> service = <span class="pl-k">new</span> SimpleService
    {
        RockstarRepository = <span class="pl-k">new</span> RockstarRepositoryMock()
    };

    <span class="pl-k">var</span> status = service.Get(<span class="pl-k">new</span> GetStatus { LastName = <span class="pl-s"><span class="pl-pds">"</span>Vedder<span class="pl-pds">"</span></span> });
    Assert.That(status.Age, Is.EqualTo(<span class="pl-c1">48</span>));
    Assert.That(status.Alive, Is.True);

    Assert.Throws&lt;HttpError&gt;(() =&gt;
        service.Get(<span class="pl-k">new</span> GetStatus { LastName = <span class="pl-s"><span class="pl-pds">"</span>Hendrix<span class="pl-pds">"</span></span> }));
}</pre></div>

<p>This example doesn't need a container as we're injecting all the dependencies manually.</p>

<h1>
<a id="user-content-community-resources" class="anchor" href="#community-resources" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Community Resources</h1>

<ul>
<li>
<a href="http://kylehodgson.com/2014/06/03/servicestack-4-http-utilities-contract-testing/">ServiceStack 4 HTTP Utilities: Contract Testing</a> by <a href="https://twitter.com/kylehodgson">@kylehodgson</a>
</li>
<li>
<a href="http://iwayneo.blogspot.co.uk/2014/05/regression-testing-servicestack.html">Regression testing ServiceStack services with RavenDB embedded</a> by <a href="https://twitter.com/wayne_douglas">@wayne_douglas</a>
</li>
<li><a href="http://dilanperera.wordpress.com/2014/02/23/servicestack-testing-services-with-chrome-rest-console/">ServiceStack – Testing services with Chrome REST Console</a></li>
<li>
<a href="http://tech.pro/tutorial/1276/servicestack-and-ravendb-end-to-end-testing">ServiceStack and RavenDB End to End Testing</a> by <a href="https://twitter.com/AquaBirdConsult">@aquabirdconsult</a>
</li>
<li>
<a href="http://rossipedia.com/blog/2013/02/integration-testing-with-servicestack/">Integration Testing With ServiceStack</a> by <a href="https://twitter.com/rossipedia">@rossipedia</a>
</li>
<li>
<a href="http://www.rickardnilsson.net/post/2013/01/19/how-to-unit-test-your-database-code-when-using-servicestack-ormlite.aspx">How to unit test your database code when using ServiceStack OrmLite</a> by <a href="https://twitter.com/rickardn">@rickardn</a>
</li>
<li>
<a href="http://blogs.lessthandot.com/index.php/DesktopDev/MSTech/easyhttp-and-servicestack-making-it">EasyHttp and ServiceStack, making the mspec tests better</a> by <a href="https://twitter.com/chrissie1">@chrissie1</a>
</li>
<li>
<a href="http://blogs.lessthandot.com/index.php/DesktopDev/MSTech/using-servicestack-for-the-easyhttp">Using ServiceStack for the EasyHttp integration tests</a> by <a href="https://twitter.com/chrissie1">@chrissie1</a>
</li>
<li><a href="http://nikosbaxevanis.com/2012/02/18/parameterized-tests-for-servicestack-web-services/">Parameterized Tests for ServiceStack Web Services</a></li>
</ul>

<h3>
<a id="user-content-stack-overflow" class="anchor" href="#stack-overflow" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Stack Overflow</h3>

<ul>
<li><a href="http://stackoverflow.com/a/14791657/85785">Unit Test HTTPRequest Headers with ServiceStack</a></li>
<li><a href="http://stackoverflow.com/a/9587745/85785">Service stack and Mocking, any tutorials?</a></li>
<li><a href="http://stackoverflow.com/a/15012300/85785">How do you mock ServiceStack ISession using Moq and StructureMap?</a></li>
</ul>
